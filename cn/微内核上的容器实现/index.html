<!DOCTYPE html>
<html lang="en">

<!-- Head tag (contains Google-Analytics、Baidu-Tongji)-->
<head>
  <!-- Google Analytics -->
  
    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async="async" src="https://www.googletagmanager.com/gtag/js?id=UA-xxxxxx-xx"></script>
    <script type="text/javascript">
      window.dataLayer = window.dataLayer || [];

      function gtag() {
        dataLayer.push(arguments);
      }
      gtag('js', new Date());

      gtag('config', 'UA-xxxxxx-xx');
    </script>
  

  <!-- Baidu Tongji -->
  
    <script type="text/javascript">
      // Originial
      var _hmt = _hmt || [];
      (function () {
        var hm = document.createElement("script");
        hm.src = "https://hm.baidu.com/hm.js?xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx";
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(hm, s);
      })();
    </script>
  

  <!-- Baidu Push -->
  
    <script>
      (function () {
        var bp = document.createElement('script');
        var curProtocol = window.location.protocol.split(':')[0];
        if (curProtocol === 'https') {
          bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
        } else {
          bp.src = 'http://push.zhanzhang.baidu.com/push.js';
        }
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(bp, s);
      })();
    </script>
  

  <meta charset="utf-8"/>
  <meta http-equiv="X-UA-Compatible" content="IE=edge"/>

  <meta name="google-site-verification" content="lxDfCplOZbIzjhG34NuQBgu2gdyRlAtMB4utP5AgEBc"/>
  <meta name="baidu-site-verification" content="PpzM9WxOJU"/>

  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="description" content="Are we so helpless against the tide ?"/>
  <meta name="keyword" content=""/>
  <link rel="shortcut icon" href="/img/avatar/yaolan1.jpg"/>

  <!-- Place this tag in your head or just before your close body tag. -->
  <script async="async" defer="defer" src="https://buttons.github.io/buttons.js"></script>

  
    <!-- Bootstrap Core CSS -->
    <link rel="stylesheet" href="/css/bootstrap.min.css"/>

    <!-- Custom CSS -->
    <link rel="stylesheet" href="/css/beantech.min.css"/>

    <!-- Pygments Highlight CSS -->
    <link rel="stylesheet" href="/css/highlight.css"/>
    <link rel="stylesheet" href="/css/widget.css"/>
    <link rel="stylesheet" href="/css/rocket.css"/>
    <link rel="stylesheet" href="/css/signature.css"/>
    <link rel="stylesheet" href="/css/catalog.css"/>
    <link rel="stylesheet" href="/css/livemylife.css"/>

    
      <!-- wave start -->
      <link rel="stylesheet" href="/css/wave.css"/>
      <!-- wave end -->
    

    
      <!-- top start (article top hot config) -->
      <link rel="stylesheet" href="/css/top.css"/>
      <!-- top end -->
    

    
      <!-- ThemeColor start -->
      <link rel="stylesheet" href="/css/scroll.css"/>
      <!-- ThemeColor end -->
    

    
      <!-- viewer start (Picture preview) -->
      <link rel="stylesheet" href="/css/viewer.min.css"/>
      <!-- viewer end -->
    

    
      <!-- Search start -->
      <link rel="stylesheet" href="/css/search.css"/>
      <!-- Search end -->
    

    
      <!-- ThemeColor start -->
      <link rel="stylesheet" href="/css/themecolor.css"/>
      <!-- ThemeColor end -->
    

    
      <!-- gitment start -->
      <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/theme-next/theme-next-gitment@1/default.css"/>
      <!-- gitment end -->
    

    
  

  <!-- Custom Fonts -->
  <!-- <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css" rel="stylesheet" type="text/css"> -->
  <!-- Hux change font-awesome CDN to qiniu -->
  <link rel="stylesheet" href="https://cdn.staticfile.org/font-awesome/4.5.0/css/font-awesome.min.css" type="text/css">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

  <!-- Hux Delete, sad but pending in China <link href='http://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic' rel='stylesheet' type='text/css'> <link
  href='http://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800' rel='stylesheet' type='text/ css'> -->

  <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
  <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
  <!--[if lt IE 9]> <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script> <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script> <![endif]-->

  <!-- ga & ba script hoook -->
  <link rel="canonical" href="https://every-breaking-wave.github.io/cn/微内核上的容器实现/">
  <title>
    
      微内核容器实现 - breaking-wave&#39;s blog
    
  </title>
<meta name="generator" content="Hexo 5.4.0"></head>


<!-- hack iOS CSS :active style -->

	<body ontouchstart="" class="body--light body--light">


		<!-- ThemeColor -->
		
		<!-- ThemeColor -->
<style type="text/css">
  .body--light {
    --light-mode: none;
    --dark-mode: block;
  }
  .body--dark {
    --light-mode: block;
    --dark-mode: none;
  }
  i.mdui-icon.material-icons.light-mode {
    display: var(--light-mode);
  }
  i.mdui-icon.material-icons.dark-mode {
    display: var(--dark-mode);
  }
</style>
<div class="toggle" onclick="document.body.classList.toggle('body--dark')">
  <i class="mdui-icon material-icons light-mode"></i>
  <i class="mdui-icon material-icons dark-mode"></i>
</div>
<script>
  //getCookieValue
  function getCookieValue(a) {
    var b = document.cookie.match('(^|[^;]+)\\s*' + a + '\\s*=\\s*([^;]+)');
    return b
      ? b.pop()
      : '';
  }
  let themeMode = 'light';
  if (getCookieValue('sb-color-mode') && (getCookieValue('sb-color-mode') !== themeMode)) {
    let dbody = document.body.classList;
    themeMode === 'dark' ? dbody.remove('body--dark') : dbody.add('body--dark');
  }

  //setCookieValue
  var toggleBtn = document.querySelector(".toggle");
  toggleBtn.addEventListener("click", function () {
    var e = document.body.classList.contains("body--dark");
    var cookieString = e
      ? "dark"
      : "light";
    var exp = new Date();
    exp.setTime(exp.getTime() + 3 * 24 * 60 * 60 * 1000); //3天过期
    document.cookie = "sb-color-mode=" + cookieString + ";expires=" + exp.toGMTString() + ";path=/";
  });
</script>

		

		<!-- Gitter -->
		
		<!-- Gitter -->
<!-- Docs:https://gitter.im/?utm_source=left-menu-logo -->
<script>
  ((window.gitter = {}).chat = {}).options = {
    room: 'Wave&#39;s World/community'
  };
</script>
<script src="https://sidecar.gitter.im/dist/sidecar.v1.js" async defer></script>

		

		<!-- Navigation (contains search)-->
		<!-- Navigation -->
<nav class="navbar navbar-default navbar-custom navbar-fixed-top">
  <div class="container-fluid">
    <!-- Brand and toggle get grouped for better mobile display -->
    <div class="navbar-header page-scroll">
      <button type="button" class="navbar-toggle">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="/">breaking-wave&#39;s coding zone</a>
    </div>

    <!-- Collect the nav links, forms, and other content for toggling -->
    <!-- Known Issue, found by Hux: <nav>'s height woule be hold on by its content. so, when navbar scale out, the <nav> will cover tags. also mask any touch event of tags, unfortunately. -->
    <div id="huxblog_navbar">
      <div class="navbar-collapse">
        <ul class="nav navbar-nav navbar-right">
          <li>
            <a href="/">首页</a>
          </li>

          
          
          
          
          <li>
            <a href="/about/">
              
              关于
              
              
            </a>
          </li>
          
          
          
          <li>
            <a href="/archive/">
              
              归档
              
              
            </a>
          </li>
          
          
          
          <li>
            <a href="/categories/">
              
              分类
              
              
            </a>
          </li>
          
          
          
          <li>
            <a href="/tags/">
              
              标签
              
              
            </a>
          </li>
          
          

          
          <li>
            <a class="popup-trigger">
              <span class="search-icon"></span>搜索</a>
          </li>
          

          <!-- LangSelect -->
          
          
          
          
          
        </ul>
      </div>
    </div>
    <!-- /.navbar-collapse -->
  </div>
  <!-- /.container -->
</nav>
<!-- progress -->
<div id="progress">
  <div class="line" style="width: 0%;"></div>
</div>

<script>
  // Drop Bootstarp low-performance Navbar Use customize navbar with high-quality material design animation in high-perf jank-free CSS3 implementation
  var $body = document.body;
  var $toggle = document.querySelector('.navbar-toggle');
  var $navbar = document.querySelector('#huxblog_navbar');
  var $collapse = document.querySelector('.navbar-collapse');

  $toggle.addEventListener('click', handleMagic)

  function handleMagic(e) {
    if ($navbar.className.indexOf('in') > 0) {
      // CLOSE
      $navbar.className = " ";
      // wait until animation end.
      setTimeout(function() {
        // prevent frequently toggle
        if ($navbar.className.indexOf('in') < 0) {
          $collapse.style.height = "0px"
        }
      }, 400)
    } else {
      // OPEN
      $collapse.style.height = "auto"
      $navbar.className += " in";
    }
  }
</script>


		<!-- Post Header (contains intro-header、signature、wordcount、busuanzi、waveoverlay) -->
		<!-- Modified by Yu-Hsuan Yen -->
<!-- Post Header -->

  <style type="text/css">
    .body--light {
      /* intro-header */
      --intro-header-background-image-url-home: url('/img/header_img/hiten2.jpg');
      --intro-header-background-image-url-post: url('/img/header_img/lml_bg.jpg');
      --intro-header-background-image-url-page: url('//img/header_img/lml_bg.jpg');
    }
    .body--dark {
      --intro-header-background-image-url-home: linear-gradient(rgba(0, 0, 0, 0.1), rgba(0, 0, 0, 0.2)), url('/img/header_img/hiten2.jpg');
      --intro-header-background-image-url-post: linear-gradient(rgba(0, 0, 0, 0.1), rgba(0, 0, 0, 0.2)), url('/img/header_img/lml_bg.jpg');
      --intro-header-background-image-url-page: linear-gradient(rgba(0, 0, 0, 0.1), rgba(0, 0, 0, 0.2)), url('//img/header_img/lml_bg.jpg');
    }

    header.intro-header {
       /*post*/
        background-image: var(--intro-header-background-image-url-post);
        /* background-image: url('/img/header_img/lml_bg.jpg'); */
      
    }

    
      #signature {/*signature*/
        background-image: url('/img/signature/signature.png');
      }
    
  </style>





<header class="intro-header">
  <!-- Signature -->
  <div id="signature">
    <div class="container">
      <div class="row">
        <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
          
          <div class="post-heading">
            <div class="tags">
              
              <a class="tag" href="/tags/#经验总结" title="经验总结">经验总结</a>
              
            </div>
            <h1>微内核容器实现</h1>
            <h2 class="subheading"></h2>
            <span class="meta">
              Posted by breaking-wave on
              2023-10-17
            </span>


            
            <!-- WordCount start -->
            <div class="blank_box"></div>
            <span class="meta">
              Estimated Reading Time <span class="post-count">11</span> Minutes
            </span>
            <div class="blank_box"></div>
            <span class="meta">
              Words <span class="post-count">2.9k</span> In Total
            </span>
            <div class="blank_box"></div>
            <!-- WordCount end -->
            
            
            <!-- 不蒜子统计 start -->
            <span class="meta" id="busuanzi_container_page_pv">
              Viewed <span id="busuanzi_value_page_pv"><i class="fa fa-spinner fa-spin"></i></span> Times
            </span>
            <!-- 不蒜子统计 end -->
            


          </div>
          
        </div>
      </div>
    </div>
  </div>

  
  <!-- waveoverlay start -->
  <div class="preview-overlay">
    <svg class="preview-waves" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto">
      <defs>
        <path id="gentle-wave" d="M-160 44c30 0 58-18 88-18s 58 18 88 18 58-18 88-18 58 18 88 18 v44h-352z"></path>
      </defs>
      <g class="preview-parallax">
        <use xlink:href="#gentle-wave" x="48" y="0" fill=var(--gentle-wave1)></use>
        <use xlink:href="#gentle-wave" x="48" y="3" fill=var(--gentle-wave2)></use>
        <use xlink:href="#gentle-wave" x="48" y="5" fill=var(--gentle-wave3)></use>
        <use xlink:href="#gentle-wave" x="48" y="7" fill=var(--gentle-wave)></use>
      </g>
    </svg>
  </div>
  <!-- waveoverlay end -->
  

</header>



		<!-- Main Content (Post contains
	Pager、
	tip、
	socialshare、
	gitalk、gitment、disqus-comment、
	Catalog、
	Sidebar、
	Featured-Tags、
	Friends Blog、
	anchorjs、
	) -->
		<!-- Modify by Yu-Hsuan Yen -->
<!-- Post Content -->
<article>
  <div class="container">
    <div class="row">
      <!-- Post Container -->
      <div class="col-lg-8 col-lg-offset-1 col-md-10 col-md-offset-1 post-container">

        <p>众所周知Docker的实现基于Linux内核提供的cgroup和namespace两个功能，本篇文章的目的是在chcore这一微内核架构上实现这两个功能，也就是实现微内核上的容器功能。</p>
<h1 id="实现Cgroup"><a href="#实现Cgroup" class="headerlink" title="实现Cgroup"></a>实现Cgroup</h1><p>需要考虑两个方面</p>
<ul>
<li>内核层面的cgroup支持</li>
<li>与内核交互的接口</li>
</ul>
<p>Linux内核实现了一系列的数据结构如cgroup_subsys和cftype等，具体数据结构关系如下如所示，有够复杂</p>
<p><img src="https://wave-pics.oss-cn-shanghai.aliyuncs.com/pics/image-20231017220833380.png" alt="image-20231017220833380"></p>
<p>关于cgroup的原理和源码解析，可以参考: <a target="_blank" rel="noopener" href="https://blog.csdn.net/zy_dreamer/article/details/131870061">CGroup 实现原理</a> , <a target="_blank" rel="noopener" href="https://blog.csdn.net/zy_dreamer/article/details/131870035">CGroup源码分析</a></p>
<h2 id="Linux中的Cgroup实现简析"><a href="#Linux中的Cgroup实现简析" class="headerlink" title="Linux中的Cgroup实现简析"></a>Linux中的Cgroup实现简析</h2><p>Linux将进程以Cgroup为单位切分实现资源隔离，效果如图所示</p>
<p><img src="https://wave-pics.oss-cn-shanghai.aliyuncs.com/pics/image-20231017220909279.png" alt="image-20231017220909279" style="zoom:67%;" /></p>
<p>实际上<code>cgroup</code>的实现相当复杂，因为涉及到多种资源的控制，下面我主要从设计者的角度分析其实现思路，并简要结合源码分析。</p>
<h3 id="实现一个简单的进程组"><a href="#实现一个简单的进程组" class="headerlink" title="实现一个简单的进程组"></a>实现一个简单的进程组</h3><p>其实简单来说，只要我们定义一个数据结构，能够记录一组进程以及它们对应的资源限制即可。</p>
<p>以下是一个朴素的设计思路:</p>
<p><img src="https://wave-pics.oss-cn-shanghai.aliyuncs.com/pics/image-20231017220924488.png" alt="image-20231017220924488" style="zoom:50%;" /></p>
<p>我们通过链表来将进程组织成进程组，并且在计数器中增加一个 <code>task_group</code> 字段，让其指向进程组。当进程组中的进程申请内存时，可以通过指针来找到对应的计数器，并且增加计数器的 <code>count</code> 字段。</p>
<p>就这样，我们设计了一个简单的进程组功能。如果系统只有内存这种资源的话，的确可以这样设计。但是系统除了内存，还有CPU、硬盘和网络这些资源，所以 Linux 创建了一种比较通用的方式来组织进程组，也就是cgroup。</p>
<h3 id="通过Hierarchy组织CGroup"><a href="#通过Hierarchy组织CGroup" class="headerlink" title="通过Hierarchy组织CGroup"></a>通过Hierarchy组织CGroup</h3><p>Linux将<code>CGroup</code> 当成是一个目录，由于目录有层级关系，所以 <code>CGroup</code> 也有层级关系，如下图所示：</p>
<p><img src="https://wave-pics.oss-cn-shanghai.aliyuncs.com/pics/image-20231017211930283.png" alt="image-20231017211930283"></p>
<p>每个控制组都记录着自己包含的进程列表（实际上，它被记录在对应目录中一个叫<code>tasks</code>的文件中）。</p>
<p>在内核中，控制组使用 <code>cgroup</code> 结构来表示，其定义如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">cgroup</span> &#123;</span></span><br><span class="line">    ...</span><br><span class="line">    <span class="comment">// 下面3个字段把控制组连接成一个树结构</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">sibling</span>;</span>   <span class="comment">// 兄弟节点</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">children</span>;</span>  <span class="comment">// 子节点</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">cgroup</span> *<span class="title">parent</span>;</span>      <span class="comment">// 父节点</span></span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">dentry</span> *<span class="title">dentry</span>;</span>      <span class="comment">// 当前控制组对应的目录对象</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 当前控制组关联的子系统资源统计对象</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">cgroup_subsys_state</span> *<span class="title">subsys</span>[<span class="title">CGROUP_SUBSYS_COUNT</span>];</span> </span><br><span class="line">    ...</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>内核通过 <code>cgroup</code> 结构的 <code>sibling</code>、<code>children</code> 和 <code>parent</code> 这3个字段来将 <code>控制组</code> 组织成一棵树状结构，这就是组织<code>cgroup</code>的<code>hierarchy</code>。如下图所示：</p>
<p><img src="https://wave-pics.oss-cn-shanghai.aliyuncs.com/pics/image-20231017212149330.png" alt="image-20231017212149330" style="zoom:47%;" /></p>
<h3 id="关联Hierarchy与Subsys"><a href="#关联Hierarchy与Subsys" class="headerlink" title="关联Hierarchy与Subsys"></a>关联Hierarchy与Subsys</h3><p><code>cgroup</code> 结构的 <code>subsys</code> 字段表示当前控制组关联的<code>子系统状态对象</code>，也就是cpu或者memory这种资源对象，一个<code>cgroup</code>可以关联到多个<code>subsys</code>，处在同一个<code>Hierarchy</code>的<code>cgroup</code>必然关联到同一个<code>subsys</code>。</p>
<p>在Linux中，每种<code>subsys</code>都由一个名为 <code>cgroup_subsys</code> 的结构来描述，其定义如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">cgroup_subsys</span> &#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">cgroup_subsys_state</span> *(*<span class="title">create</span>)(<span class="keyword">struct</span> <span class="title">cgroup_subsys</span> *<span class="title">ss</span>, </span></span><br><span class="line"><span class="class">                                          <span class="keyword">struct</span> <span class="title">cgroup</span> *<span class="title">cgrp</span>);</span></span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">void</span> (*attach)(struct cgroup_subsys *ss, struct cgroup *cgrp,</span><br><span class="line">                   struct cgroup *old_cgrp, struct task_struct *tsk);</span><br><span class="line">    <span class="keyword">void</span> (*fork)(struct cgroup_subsys *ss, struct task_struct *task);</span><br><span class="line">    <span class="keyword">void</span> (*<span class="built_in">exit</span>)(struct cgroup_subsys *ss, struct task_struct *task);</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">int</span> subsys_id;</span><br><span class="line">    <span class="keyword">int</span> active;</span><br><span class="line">    <span class="keyword">int</span> disabled;</span><br><span class="line">    <span class="keyword">int</span> early_init;</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span> *name;            <span class="comment">// 子系统名字</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">cgroupfs_root</span> *<span class="title">root</span>;</span>  <span class="comment">// 关联的层级根节点</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">sibling</span>;</span></span><br><span class="line">    <span class="keyword">void</span> *<span class="keyword">private</span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>在内核中，<code>hierarchy</code>的根结点使用 <code>cgroupfs_root</code>结构来表示， 定义如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">cgroupfs_root</span> &#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">super_block</span> *<span class="title">sb</span>;</span>            <span class="comment">// 挂载点超级块对象（虚拟文件系统使用）</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> subsys_bits;         <span class="comment">// 当前层级绑定的资源子系统位图（1表示已经绑定到当前层级）</span></span><br><span class="line">    ...</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">subsys_list</span>;</span>      <span class="comment">// 绑定到当前层级的资源子系统列表</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">cgroup</span> <span class="title">top_cgroup</span>;</span>          <span class="comment">// 当前层级的根控制组</span></span><br><span class="line">    <span class="keyword">int</span> number_of_cgroups;             <span class="comment">// 当前层级拥有的控制组数量</span></span><br><span class="line">    ...</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>所以将<code>hierarchy</code>与<code>subsys</code>建立关联就是将<code>cgroup_subsys</code>的<code>cgroupfs_root</code>修改为对应的根节点即可。</p>
<p>在 Linux 内核中，可以存在多个 <code>hierarchy</code>，每个<code>hierarchy</code>可以关联一个或多个 <code>资源控制子系统</code>，但同一个 <code>subsys</code> 不能关联到多个<code>hierarchy</code>中（这其实也很好理解，因为<code>cgroup_subsys</code>的<code>cgroupfs_root</code>只有一个）。如下图所示：</p>
<p><img src="https://wave-pics.oss-cn-shanghai.aliyuncs.com/pics/image-20231017212249021.png" alt="image-20231017212249021"></p>
<p>在上述两图中，memory和cpu这两个<code>subsys</code>都已经被关联，因此不可能再有新的<code>hierarchy</code>与他们产生关联，但是支持将他们关联到同一个<code>hierarchy</code>上，如</p>
<p><img src="https://wave-pics.oss-cn-shanghai.aliyuncs.com/pics/image-20231017212704938.png" alt="image-20231017212704938" style="zoom:67%;" /></p>
<p>在 Linux 内核中，有个名为 <code>rootnode</code> 的根层级，在系统启动后，由内核自动创建并且初始化的层级。系统启动后，所有的资源控制子系统都关联到此层级。</p>
<p>如果用户想把资源控制子系统关联到其他层级，那么可以使用 <code>mount</code> 命令来进行挂载，如下命令所示：</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ mount -t cgroup -o memory memory /sys/fs/cgroup/memory</span><br></pre></td></tr></table></figure>
<p>上面的命令用于将内存<code>subsys</code>重新关联到 <code>/sys/fs/cgroup/memory</code> 这个<code>hierarchy</code>。</p>
<h3 id="资源统计对象"><a href="#资源统计对象" class="headerlink" title="资源统计对象"></a>资源统计对象</h3><p>将<code>hierarchy</code>与<code>subsys</code>关联之后，我们还需要记录每个<code>cgroup</code>在这个<code>subsys</code>上使用的资源总量。</p>
<p>在上面的实例中，我们使用一个计数器来统计进程组对内存资源的使用情况，每个 <code>cgroup</code> 都需要一个这样的计数器来统计和限制进程组对内存资源的使用。</p>
<p>在 Linux 内核中也有类似的 “计数器“，使用 <code>cgroup_subsys_state</code> 结构来表示（我们称它为 <code>资源统计对象</code>），其定义如下：</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">struct cgroup_subsys_state &#123;</span><br><span class="line">    struct cgroup *cgroup; // 指向控制组对象</span><br><span class="line">    atomic_t refcnt;       // 引用计数器</span><br><span class="line">    unsigned long flags;   // 标志位</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p><code>cgroup_subsys_state</code> 结构看起来非常简单，这只是表面现象。内核为了将所有的 <code>cgroup_subsys_state</code> 抽象化（也就是都能用 <code>cgroup_subsys_state</code> 指针来指向所有类型的 <code>资源统计对象</code>），才定义出这个通用的部分，实际上的 <code>cgroup_subsys_state</code> 是比较复杂的。</p>
<p>例如内存的基于cgroup_subsys_state的资源统计对象定义如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">mem_cgroup</span> &#123;</span></span><br><span class="line">    <span class="comment">// 资源统计对象通用部分</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">cgroup_subsys_state</span> <span class="title">css</span>;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 资源统计对象私有部分</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">res_counter</span> <span class="title">res</span>;</span>  <span class="comment">// 用于统计进程组的内存使用情况</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">mem_cgroup_lru_info</span> <span class="title">info</span>;</span></span><br><span class="line">    <span class="keyword">int</span> prev_priority;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">mem_cgroup_stat</span> <span class="title">stat</span>;</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p><code>mem_cgroup</code> 结构与 <code>cgroup_subsys_state</code> 结构的关系如下图所示：</p>
<p><img src="https://wave-pics.oss-cn-shanghai.aliyuncs.com/pics/image-20231017213609300.png" alt="image-20231017213609300" style="zoom:37%;" /></p>
<p><code>资源统计对象</code> 必须与 <code>控制组</code> 绑定，才能实现限制 <code>控制组</code> 对资源的使用。前面我们了解到 <code>cgroup</code> 结构中有个名为 <code>subsys</code> 的字段，如下代码所示：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">cgroup</span> &#123;</span></span><br><span class="line">    ...</span><br><span class="line">    <span class="comment">// 当前控制组关联的资源统计对象</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">cgroup_subsys_state</span> *<span class="title">subsys</span>[<span class="title">CGROUP_SUBSYS_COUNT</span>];</span> </span><br><span class="line">    ...</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>可以看出，<code>subsys</code> 字段是一个 <code>cgroup_subsys_state</code> 结构的数组，数组的大小为系统支持的 <code>资源控制子系统</code> 数（也就是说，数组上的每个槽位对应着一个子系统资统计对象）。如下图所示：</p>
<p><img src="https://wave-pics.oss-cn-shanghai.aliyuncs.com/pics/image-20231017213720044.png" alt="image-20231017213720044"></p>
<p>在 Linux 内核中，一个进程可以属于多个 <code>控制组</code>，而每个 <code>控制组</code> 又关联着一个或多个 <code>资源统计对象</code>。所以，一个进程所关联的 <code>资源统计对象</code> 是其所在 <code>控制组</code> 关联的 <code>资源统计对象</code> 的集合。这句话有点难懂，我们用一幅图来说明：</p>
<p><img src="https://wave-pics.oss-cn-shanghai.aliyuncs.com/pics/image-20231017222348578.png" alt="image-20231017222348578"></p>
<p>如上图所示：</p>
<ul>
<li><code>进程A</code> 属于控制组 <code>/sys/fs/cgroup/memory/cgrp1/cgrp3</code> 和控制组 <code>/sys/fs/cgroup/cpu/cgrp2/cgrp3</code>，所以 <code>进程A</code> 就关联了 <code>mem_group A</code> 和 <code>task_group A</code> 这两个资源统计对象。</li>
<li><code>进程B</code> 属于控制组 <code>/sys/fs/cgroup/memory/cgrp1/cgrp4</code> 和控制组 <code>/sys/fs/cgroup/cpu/cgrp2/cgrp3</code>，所以 <code>进程B</code> 就关联了 <code>mem_group B</code> 和 <code>task_group A</code> 这两个资源统计对象。</li>
</ul>
<p>进程通过 <code>css_set</code> 结构来收集不同<code>cgroup</code>的 <code>资源统计对象</code>，其定义如下：</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">struct css_set &#123;</span><br><span class="line">    ...</span><br><span class="line">    // 用于收集不同控制组的资源统计对象</span><br><span class="line">    struct cgroup_subsys_state *subsys[CGROUP_SUBSYS_COUNT];</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>在 <code>进程描述符结构（task_struct）</code> 中有个指向 <code>css_set</code> 结构的指针，如下所示：</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">struct task_struct &#123;</span><br><span class="line">    ...</span><br><span class="line">    struct css_set *cgroups;</span><br><span class="line">    ...</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>所以，当把一个进程添加到一个 <code>cgroup</code> 时，将会把 <code>cgroup</code> 关联的 <code>资源统计对象</code> 添加到进程的 <code>cgroups</code> 字段中，从而使进程受到这些 <code>资源统计对象</code> 的限制 （这句话是实现cgroup控制的进程的精髓）。</p>
<h2 id="如何在Chcore中实现Cgroup功能"><a href="#如何在Chcore中实现Cgroup功能" class="headerlink" title="如何在Chcore中实现Cgroup功能"></a>如何在Chcore中实现Cgroup功能</h2><p>我们先考虑实现memory的cgroup隔离，TA为我们提供了一个可能的思路：</p>
<p><img src="https://wave-pics.oss-cn-shanghai.aliyuncs.com/pics/image-20231020000057987.png" alt="image-20231020000057987" style="zoom:67%;" /></p>
<p>基本思路如下：</p>
<ul>
<li>在容器进程尝试分配内存并触发page fault尝试通过buddy算法获取物理页的时候修改该进程的物理内存使用量</li>
<li>该进程属于某个进程集合，且存在文件记录了这些进程的内存使用总量和上限</li>
<li>当内存总量超过上限时会触发异常（例如OOM或拒绝分配且抛出警告）</li>
<li>考虑一些corner case: Spawn/IPC 不破坏性能隔离/资源隔离</li>
</ul>
<p>这个思路是显而易见的，因此我们需要弄清楚的问题就是：</p>
<ul>
<li>chcore的内存申请的整个链路</li>
<li>怎么保存进程组的内存使用信息</li>
</ul>
<p>复习一下chcore的内存分配吧！</p>
<p><img src="https://wave-pics.oss-cn-shanghai.aliyuncs.com/pics/image-20231020160050574.png" alt="image-20231020160050574"></p>
<p>这里我们需要考虑的是fd不为1的情况，也就是内存分配而非文件内存映射，调用chcore_sys_call后，chcore会切换到el1特权级，并根据sys_call的table选择需要调用的handle函数,，以下为sys_handle_mmap的源代码:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">u64 <span class="title">sys_handle_mmap</span><span class="params">(u64 addr, <span class="keyword">size_t</span> length, <span class="keyword">int</span> prot, <span class="keyword">int</span> flags, <span class="keyword">int</span> fd,</span></span></span><br><span class="line"><span class="function"><span class="params">		    u64 offset)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">vmspace</span> *<span class="title">vmspace</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">pmobject</span> *<span class="title">pmo</span>;</span></span><br><span class="line">	<span class="keyword">vmr_prop_t</span> vmr_prot;</span><br><span class="line">	u64 map_addr;</span><br><span class="line">	<span class="keyword">int</span> new_pmo_cap;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//...delete some checks...</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Add one anonymous mapping, i.e., the cap in new_pmo_cap */</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Round up @length */</span></span><br><span class="line">	<span class="keyword">if</span> (length % PAGE_SIZE) &#123;</span><br><span class="line">		length = ROUND_UP(length, PAGE_SIZE);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Create the pmo for the mmap area */</span></span><br><span class="line">	pmo = obj_alloc(TYPE_PMO, <span class="keyword">sizeof</span>(*pmo));</span><br><span class="line">	<span class="keyword">if</span> (!pmo) &#123;</span><br><span class="line">		kinfo(<span class="string">&quot;Fail: cannot create the initial heap pmo.\n&quot;</span>);</span><br><span class="line">		BUG_ON(<span class="number">1</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">/* Set the pmo type as PMO_ANONYM */</span></span><br><span class="line">	pmo_init(pmo, PMO_ANONYM, length, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Create the cap for this pmo */</span></span><br><span class="line">	new_pmo_cap = cap_alloc(current_cap_group, pmo, <span class="number">0</span>);</span><br><span class="line">	<span class="keyword">if</span> (new_pmo_cap &lt; <span class="number">0</span>) &#123;</span><br><span class="line">		kinfo(<span class="string">&quot;Fail: cannot create cap for the new pmo\n&quot;</span>);</span><br><span class="line">		BUG_ON(<span class="number">1</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Change the vmspace */</span></span><br><span class="line">	vmspace = obj_get(current_cap_group, VMSPACE_OBJ_ID, TYPE_VMSPACE);</span><br><span class="line">	vmr_prot = get_vmr_prot(prot);</span><br><span class="line">	map_addr = vmspace_mmap_with_pmo(vmspace, pmo, length, vmr_prot);</span><br><span class="line">	obj_put(vmspace);</span><br><span class="line"></span><br><span class="line">	kdebug(<span class="string">&quot;mmap done: map_addr is %p\n&quot;</span>, map_addr);</span><br><span class="line">	<span class="keyword">return</span> map_addr;</span><br><span class="line"></span><br><span class="line">err_exit:</span><br><span class="line">	map_addr = (u64)(<span class="number">-1L</span>);</span><br><span class="line">	<span class="keyword">return</span> map_addr;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<ol>
<li>创建 pmobject 对象（<code>obj_alloc</code> $\rightarrow$<code>kzalloc$$$\rightarrow$$$kmalloc</code>）</li>
<li>创建 pmobject 对象的内核对象句柄<code>cap</code>（<code>cap_alloc$$$\rightarrow$$$kmalloc</code>）</li>
<li>映射 pmobject 对象到虚拟地址空间：<ul>
<li>获取当前进程的 vmspace 对象。</li>
<li>通过 get_vmr_prot 将传入的保护标志转换为对应的虚拟内存区域属性。</li>
<li>调用 vmspace_mmap_with_pmo ，将新创建的 pmobject 对象映射到进程的虚拟地址空间中。</li>
<li>释放 pmobject 对象的句柄和引用计数，避免内存泄漏，使用 obj_put 函数释放 pmobject 内核对象句柄。</li>
</ul>
</li>
<li>返回映射区域的起始地址给 map_addr 变量。</li>
</ol>
<p>再回顾一下chcore的kernel异常处理流程:</p>
<p>在<code>kernel/arch/xxx/irq/irq_entry.上S</code>定义分发异常。</p>
<ul>
<li>若为<code>IRQ</code>，则在<code>irq_entry.c</code>中的<code>handle_irq</code>交给平台相关的<code>plat_handle_irq</code>处理。最后调用scheduler切换到合适的线程。</li>
<li>若为<code>SYSCALL</code>，则利用<code>kernel/syscall/syscall.c</code>中的<code>syscall_table</code>通过偏移量找到对应函数的入口。</li>
<li>若为其他异常，如Page Fault，则在<code>irq_entry.c</code>中的<code>handle_entry_c</code>根据EC的不同分发到不同的入口。<code>handle_entry_c</code>中传入的两个参数：<code>esr</code>为Exception Syndrome Register，包含了导致这个exception的原因，从manual抄下来的原因在<code>register.h</code>中；<code>address</code>是导致这个异常的地址。</li>
</ul>
<p>结合以上知识，我们可以产生一些general的想法：</p>
<h3 id="tips"><a href="#tips" class="headerlink" title="tips"></a>tips</h3><ul>
<li><p>先在进程申请/释放内存的时候打印日志</p>
</li>
<li><p>构思用怎样的方式存储group-&gt;mem_use</p>
</li>
<li>看看linux是怎么进行文件操作的</li>
<li>子进程应该继承父进程的cgroup</li>
</ul>
<ul>
<li>目前似乎不能pid-&gt;cap_group，可能需要加一个全局的数据结构来保存</li>
</ul>


        <hr>
        <!-- Pager -->
        <ul class="pager">
          
          <li class="previous">
            <a href="/kernel/Linux内核编译初尝试/" data-toggle="tooltip" data-placement="top" title="Linux内核编译初尝试">&larr; Previous Post</a>
          </li>
          
          
          <li class="next">
            <a href="/paper/Borg paper reading/" data-toggle="tooltip" data-placement="top" title="Borg paper reading">Next Post &rarr;</a>
          </li>
          
        </ul>

        
        <!-- tip start -->
        <!-- tip -->
<!-- tip start -->
<div class="tip">
  <p>
    
      如果您喜欢此博客或发现它对您有用，则欢迎对此发表评论。 也欢迎您共享此博客，以便更多人可以参与。 如果博客中使用的图像侵犯了您的版权，请与作者联系以将其删除。 谢谢 ！
    
  </p>
</div>
<!-- tip end -->

        <!-- tip end -->
        

        
        <!-- Sharing Srtart -->
        <!-- Social Social Share Post -->
<!-- Docs:https://github.com/overtrue/share.js -->

<div class="social-share" data-initialized="true" data-disabled="tencent ,douban ,qzone ,linkedin ,facebook ,google ,diandian" data-wechat-qrcode-helper="" align="center">
  <ul class="list-inline text-center social-share-ul">
    <li class="social-share-li">
      <a target="_blank" class="social-share-icon icon-twitter">
        <i class="fa fa-twitter fa-1x" aria-hidden="true"></i>
      </a>
    </li>
    <li class="social-share-li">
      <a class="social-share-icon icon-wechat">
        <i class="fa fa-weixin fa-1x" aria-hidden="true"></i>
      </a>
    </li>
    <li class="social-share-li">
      <a target="_blank" class="social-share-icon icon-weibo">
        <i class="fa fa-weibo fa-1x" aria-hidden="true"></i>
      </a>
    </li>
    <li class="social-share-li">
      <a target="_blank" class="social-share-icon icon-qq">
        <i class="fa fa-qq fa-1x" aria-hidden="true"></i>
      </a>
    </li>
    <li class="social-share-li">
      <a target="_blank" class="social-share-icon" href="mailto:?subject=微内核容器实现&body=Hi,I found this website and thought you might like it https://every-breaking-wave.github.io/cn/微内核上的容器实现/">
        <i class="fa fa-envelope fa-1x" aria-hidden="true"></i>
      </a>
    </li>
  </ul>
</div>

<!-- css & js -->
<!-- <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/social-share.js/1.0.16/css/share.min.css"> -->
<script defer="defer" async="true" src="https://cdnjs.cloudflare.com/ajax/libs/social-share.js/1.0.16/js/social-share.min.js"></script>

        <!-- Sharing End -->
        
        <hr>

        <!-- comments start -->
        <!-- 1. gitalk comment -->


<!-- 2. gitment comment -->

  <!-- gitment start -->
  <!-- Docs:https://github.com/imsun/gitment -->

  <div id="blog_comments"></div>
  <!-- <link rel="stylesheet" href="https://imsun.github.io/gitment/style/default.css"> <script src="https://imsun.github.io/gitment/dist/gitment.browser.js"></script> -->

  <script src="https://cdn.jsdelivr.net/gh/theme-next/theme-next-gitment@1/gitment.browser.js"></script>

  <script>
    const myTheme = {
      render(state, instance) {
        const container = document.createElement('div')
        container.lang = "en-US"
        container.className = 'gitment-container gitment-root-container'

        // your custom component
        container.appendChild(instance.renderSomething(state, instance))
        container.appendChild(instance.renderHeader(state, instance))
        container.appendChild(instance.renderEditor(state, instance))
        container.appendChild(instance.renderComments(state, instance))
        container.appendChild(instance.renderFooter(state, instance))
        return container
      },
      renderSomething(state, instance) {
        const container = document.createElement('div')
        container.lang = "en-US"
        container.className = 'hello_visitor'
        if (state.user.login) {
          container.innerText = `Hello ${state.user.login}, Welcome to comment system`
        }
        return container
      }
    }

    const gitment = new Gitment({
      id: 'Tue Oct 17 2023 20:30:53 GMT+0800', // optional
      owner: 'every-breaking-wave',
      repo: 'myBlogComments',
      oauth: {
        client_id: '',
        client_secret: ''
      },
      desc: '',
      perPage: '10',
      maxCommentHeight: '250',
      theme: myTheme,
      // ... For more available options, check out the documentation below
    })

    gitment.render('blog_comments')
    // or gitment.render(document.getElementById('comments')) or document.body.appendChild(gitment.render())
  </script>

  <!-- gitment end -->


<!-- 3. disqus comment -->


        <!-- comments end -->
        <hr>

      </div>

      <!-- Catalog: Tabe of Content -->
      <!-- Table of Contents -->

    
      <aside id="sidebar">
        <div id="toc" class="toc-article">
        <strong class="toc-title">目录</strong>
        
          <ol class="toc-nav"><li class="toc-nav-item toc-nav-level-1"><a class="toc-nav-link" href="#%E5%AE%9E%E7%8E%B0Cgroup"><span class="toc-nav-number">1.</span> <span class="toc-nav-text">实现Cgroup</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#Linux%E4%B8%AD%E7%9A%84Cgroup%E5%AE%9E%E7%8E%B0%E7%AE%80%E6%9E%90"><span class="toc-nav-number">1.1.</span> <span class="toc-nav-text">Linux中的Cgroup实现简析</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#%E5%AE%9E%E7%8E%B0%E4%B8%80%E4%B8%AA%E7%AE%80%E5%8D%95%E7%9A%84%E8%BF%9B%E7%A8%8B%E7%BB%84"><span class="toc-nav-number">1.1.1.</span> <span class="toc-nav-text">实现一个简单的进程组</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#%E9%80%9A%E8%BF%87Hierarchy%E7%BB%84%E7%BB%87CGroup"><span class="toc-nav-number">1.1.2.</span> <span class="toc-nav-text">通过Hierarchy组织CGroup</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#%E5%85%B3%E8%81%94Hierarchy%E4%B8%8ESubsys"><span class="toc-nav-number">1.1.3.</span> <span class="toc-nav-text">关联Hierarchy与Subsys</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#%E8%B5%84%E6%BA%90%E7%BB%9F%E8%AE%A1%E5%AF%B9%E8%B1%A1"><span class="toc-nav-number">1.1.4.</span> <span class="toc-nav-text">资源统计对象</span></a></li></ol></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#%E5%A6%82%E4%BD%95%E5%9C%A8Chcore%E4%B8%AD%E5%AE%9E%E7%8E%B0Cgroup%E5%8A%9F%E8%83%BD"><span class="toc-nav-number">1.2.</span> <span class="toc-nav-text">如何在Chcore中实现Cgroup功能</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#tips"><span class="toc-nav-number">1.2.1.</span> <span class="toc-nav-text">tips</span></a></li></ol></li></ol></li></ol>
        
        </div>
      </aside>
    



      <!-- Sidebar Container -->
      <div class="
                col-lg-8 col-lg-offset-1
                col-md-10 col-md-offset-1
                sidebar-container">

        <!-- Featured Tags -->
        
        <section>
          <!-- no hr -->
          <h5>
            <a href="/tags/">特色标签</a>
          </h5>
          <div class="tags">
            
            <a class="tag" href="/tags/#经验总结" title="经验总结">经验总结</a>
            
          </div>
        </section>
        

        <!-- Friends Blog -->
        
        <hr>
        <h5>链友</h5>
        <ul class="list-inline">

          
          <li>
            <a href="https://lulu010722.cn/" target="_blank">天宇哥</a>
          </li>
          
        </ul>
        
      </div>
    </div>
  </div>
</article>



<!-- anchorjs start -->
<!-- async load function -->
<!-- anchor-js, Doc:http://bryanbraun.github.io/anchorjs/ -->
<script type="text/javascript">
  // async load function
  function async (u, c) {
    var d = document,
      t = 'script',
      o = d.createElement(t),
      s = d.getElementsByTagName(t)[0];
    o.src = u;
    if (c) {
      o.addEventListener('load', function(e) {
        c(null, e);
      }, false);
    }
    s.parentNode.insertBefore(o, s);
  };
</script>
<script type="text/javascript">
  //anchor-js, Doc:http://bryanbraun.github.io/anchorjs/
  async ("https://cdn.bootcss.com/anchor-js/1.1.1/anchor.min.js", function() {
    anchors.options = {
      visible: 'hover',
      placement: 'left',
      // icon: 'ℬ'
      icon: '❡'
    };
    anchors.add().remove('.intro-header h1').remove('.subheading').remove('.sidebar-container h5');
  });
</script>
<style>
  /* place left on bigger screen */
  @media all and (min-width: 800px) {
    .anchorjs-link {
      position: absolute;
      left: -0.75em;
      font-size: 1.1em;
      margin-top: -0.1em;
    }
  }
</style>

<!-- anchorjs end -->



		<!-- Footer (contains ThemeColor、viewer) -->
		<!-- Footer -->
<footer>
  <div class="container">
    <div class="row">
      <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
        <ul class="list-inline text-center">
          

          
            <li>
              <a target="_blank" href="https://github.com/every-breaking-wave">
                <span class="fa-stack fa-lg">
                  <i class="fa fa-circle fa-stack-2x"></i>
                  <i class="fa fa-github fa-stack-1x fa-inverse"></i>
                </span>
              </a>
            </li>
          

          

          

          

          

          

          

        </ul>
        <p class="copyright text-muted">
          Copyright &copy;
          breaking-wave
          2024
          <br>
          Theme by
          <a target="_blank" rel="noopener" href="http://beantech.org">BeanTech</a>
          <span style="display: inline-block; margin: 0 5px;">
            <i class="fa fa-heart"></i>
          </span>
          re-Ported by
          <a target="_blank" rel="noopener" href="https://v-vincen.life/">Live My Life</a>
          |
          <iframe style="margin-left: 2px; margin-bottom:-5px;" frameborder="0" scrolling="0" width="91px" height="20px" src="https://ghbtns.com/github-btn.html?user=V-Vincen&repo=V-Vincen.github.io&type=star&count=true"></iframe>
        </p>
      </div>
    </div>
  </div>
</footer>

<a id="rocket" href="#top" class=""></a>


  <!-- jQuery -->
  <script type="text/javascript" src="/js/jquery.min.js"></script>
  <!-- Bootstrap Core JavaScript -->
  <script type="text/javascript" src="/js/bootstrap.min.js"></script>
  <!-- Custom Theme JavaScript -->
  <script type="text/javascript" src="/js/hux-blog.min.js"></script>
  <!-- catalog -->
  <script async="true" type="text/javascript" src="/js/catalog.js"></script>
  <!-- totop(rocket) -->
  <script async="true" type="text/javascript" src="/js/totop.js"></script>

  
    <!-- Busuanzi JavaScript -->
    <script async="async" src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
  

  
    <!-- Scroll start -->
    <script async="async" type="text/javascript" src="/js/scroll.js"></script>
    <!-- Scroll end -->
  

  
    <!-- LangSelect start -->
    <script type="text/javascript" src="/js/langselect.js"></script>
    <!-- LangSelect end -->
  

  
    <!-- Mouseclick -->
    <script type="text/javascript" src="/js/mouseclick.js" content='The first step is as good as half over...,Laugh and grow fat...,Man proposes God disposes...,When all else is lost the future still remains...,Wasting time is robbing oneself...,Sharp tools make good work...,Cease to struggle and you cease to live...,A friend in need is a friend indeed...,Faith can move mountains...' color='#9933CC,#339933,#66CCCC,#FF99CC,#CCCCFF,#6666CC,#663399,#66CC99,#FF0033'></script>
  

  
    <!-- ribbon -->
    <script type="text/javascript" src="/js/ribbonDynamic.js"></script>
  

  






  <!-- viewer start -->
  <!-- viewer start (Picture preview) -->
  
    <script async="async" type="text/javascript" src="/js/viewer/viewer.min.js"></script>
    <script async="async" type="text/javascript" src="/js/viewer/pic-viewer.js"></script>
  

  <!-- viewer end -->


<script>
  // async load function
  function async (u, c) {
    var d = document,
      t = 'script',
      o = d.createElement(t),
      s = d.getElementsByTagName(t)[0];
    o.src = u;
    if (c) {
      o.addEventListener('load', function (e) {
        c(null, e);
      }, false);
    }
    s.parentNode.insertBefore(o, s);
  }

  // fastClick.js
  async ("https://cdn.bootcss.com/fastclick/1.0.6/fastclick.min.js", function () {
    var $nav = document.querySelector("nav");
    if ($nav)
      FastClick.attach($nav);
    }
  )
</script>

<!-- Because of the native support for backtick-style fenced code blocks right within the Markdown is landed in Github Pages, From V1.6, There is no need for Highlight.js, so Huxblog drops it officially. -
https://github.com/blog/2100-github-pages-now-faster-and-simpler-with-jekyll-3-0 - https://help.github.com/articles/creating-and-highlighting-code-blocks/ -->
<!-- <script> async ("http://cdn.bootcss.com/highlight.js/8.6/highlight.min.js", function () { hljs.initHighlightingOnLoad(); }) </script> <link href="http://cdn.bootcss.com/highlight.js/8.6/styles/github.min.css" rel="stylesheet"> -->

<!-- jquery.tagcloud.js -->
<!-- <script> // only load tagcloud.js in tag.html if ($('#tag_cloud').length !== 0) { async ("https://every-breaking-wave.github.io/js/jquery.tagcloud.js", function () { $.fn.tagcloud.defaults = { // size: { start: 1, end: 1, unit: 'em' }, color: {
start: '#bbbbee', end: '#0085a1' } }; $('#tag_cloud a').tagcloud(); }) } </script> -->


		<!-- Search -->
		
		<div class="popup search-popup local-search-popup">
  <span class="popup-btn-close">
    ESC
  </span>
  <div class="container">
    <div class="row">
      <!-- <div class="col-md-9 col-md-offset-1"> -->
      <div class="col-lg-9 col-lg-offset-1 col-md-10 col-md-offset-1 local-search-content">

        <div class="local-search-header clearfix">

          <div class="local-search-input-wrapper">
            <span class="search-icon">
              <i class="fa fa-search fa-lg" style="margin: 25px 10px 25px 20px;"></i>
            </span>
            <input autocomplete="off" placeholder="搜索..." type="text" id="local-search-input">
          </div>
        </div>
        <div id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>


  
    <script src="/js/ziploader.js"></script>
  
  <script>
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.json";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    // monitor main search box;
    var onPopupClose = function (e) {
      $('.popup').fadeOut(300);
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $('.popup').fadeIn(300);
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }
    // get search zip version
    $.get('/searchVersion.json?t=' + (+new Date()), function (res) {
      if (localStorage.getItem('searchVersion') !== res) {
        localStorage.setItem('searchVersion', res);
        initSearchJson();
      }
    });

    function initSearchJson() {
      initLoad(['/search.flv'], {
        loadOptions: {
          success: function (obj) {
            localStorage.setItem('searchJson', obj['search.json'])
          },
          error: function (e) {
            return console.log(e)
          }
        },
        returnOptions: {
          'json': TYPE_TEXT
        },
        mimeOptions: {
          'json': 'application/json'
        }
      })
    }
    // search function;
    var searchFunc = function (search_id, content_id) {
      'use strict';
      isfetched = true;
      var datas = JSON.parse(localStorage.getItem('searchJson'));
      // console.log(search_id)
      var input = document.getElementById(search_id);
      var resultContent = document.getElementById(content_id);
      var inputEventFunction = function () {
        var searchText = input.value.trim().toLowerCase();
        var keywords = searchText.split(/[\s\-]+/);
        if (keywords.length > 1) {
          keywords.push(searchText);
        }
        var resultItems = [];
        if (searchText.length > 0) {
          // perform local searching
          datas.forEach(function (data) {
            var isMatch = false;
            var hitCount = 0;
            var searchTextCount = 0;
            var title = data.title
              ? data.title.trim()
              : '';
            var titleInLowerCase = title.toLowerCase();
            var content = data.content
              ? data.content.trim().replace(/<[^>]+>/g, "")
              : '';
            var contentInLowerCase = content.toLowerCase();
            var articleUrl = decodeURIComponent(data.url);

            var date = data.date;
            var dateTime = date.replace(/T/, " ").replace(/.000Z/, "");
            var imgUrl = data.header_img;
            


            var indexOfTitle = [];
            var indexOfContent = [];
            // only match articles with not empty titles
            keywords.forEach(function (keyword) {
              function getIndexByWord(word, text, caseSensitive) {
                var wordLen = word.length;
                if (wordLen === 0) {
                  return [];
                }
                var startPosition = 0,
                  position = [],
                  index = [];
                if (!caseSensitive) {
                  text = text.toLowerCase();
                  word = word.toLowerCase();
                }
                while ((position = text.indexOf(word, startPosition)) > -1) {
                  index.push({position: position, word: word});
                  startPosition = position + wordLen;
                }
                return index;
              }
              indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
              indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
            });
            if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
              isMatch = true;
              hitCount = indexOfTitle.length + indexOfContent.length;
            }
            // show search results
            if (isMatch) {
              // sort index by position of keyword
              [indexOfTitle, indexOfContent].forEach(function (index) {
                index.sort(function (itemLeft, itemRight) {
                  if (itemRight.position !== itemLeft.position) {
                    return itemRight.position - itemLeft.position;
                  } else {
                    return itemLeft.word.length - itemRight.word.length;
                  }
                });
              });
              // merge hits into slices
              function mergeIntoSlice(text, start, end, index) {
                var item = index[index.length - 1];
                var position = item.position;
                var word = item.word;
                var hits = [];
                var searchTextCountInSlice = 0;
                while (position + word.length <= end && index.length != 0) {
                  if (word === searchText) {
                    searchTextCountInSlice++;
                  }
                  hits.push({position: position, length: word.length});
                  var wordEnd = position + word.length;
                  // move to next position of hit
                  index.pop();
                  while (index.length != 0) {
                    item = index[index.length - 1];
                    position = item.position;
                    word = item.word;
                    if (wordEnd > position) {
                      index.pop();
                    } else {
                      break;
                    }
                  }
                }
                searchTextCount += searchTextCountInSlice;
                return {hits: hits, start: start, end: end, searchTextCount: searchTextCountInSlice};
              }
              var slicesOfTitle = [];
              if (indexOfTitle.length != 0) {
                slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
              }
              var slicesOfContent = [];
              while (indexOfContent.length != 0) {
                var item = indexOfContent[indexOfContent.length - 1];
                var position = item.position;
                var word = item.word;
                // cut out 100 characters
                var start = position - 20;
                var end = position + 80;
                if (start < 0) {
                  start = 0;
                }
                if (end < position + word.length) {
                  end = position + word.length;
                }
                if (end > content.length) {
                  end = content.length;
                }
                slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
              }
              // sort slices in content by search text's count and hits' count
              slicesOfContent.sort(function (sliceLeft, sliceRight) {
                if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                  return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                  return sliceRight.hits.length - sliceLeft.hits.length;
                } else {
                  return sliceLeft.start - sliceRight.start;
                }
              });
              // select top N slices in content
              var upperBound = parseInt('1');
              if (upperBound >= 0) {
                slicesOfContent = slicesOfContent.slice(0, upperBound);
              }
              // highlight title and content
              function highlightKeyword(text, slice) {
                var result = '';
                var prevEnd = slice.start;
                slice.hits.forEach(function (hit) {
                  result += text.substring(prevEnd, hit.position);
                  var end = hit.position + hit.length;
                  result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                  prevEnd = end;
                });
                result += text.substring(prevEnd, slice.end);
                return result;
              }
              var resultItem = '';

              // if (slicesOfTitle.length != 0) {   resultItem += "<li><a target='_blank' href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>"; } else {   resultItem += "<li><a target='_blank' href='" +
              // articleUrl + "' class='search-result-title'>" + title + "</a>"; } slicesOfContent.forEach(function (slice) {   resultItem += "<a target='_blank' href='" + articleUrl + "'><p class=\"search-result\">" + highlightKeyword(content, slice) +
              // "...</p></a>"; }); resultItem += "</li>";

              if (slicesOfTitle.length != 0) {
                resultItem += "<a target='_blank' href='" + articleUrl + "' class='search-result'><div class='search-result-left'><div class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</div><time class='search-result-date'>" + dateTime + "</time>";
              } else {
                resultItem += "<a target='_blank' href='" + articleUrl + "' class='search-result'><div class='search-result-left'><div class='search-result-title'>" + title + "</div><time class='search-result-date'>" + dateTime + "</time>";
              }
              slicesOfContent.forEach(function (slice) {
                resultItem += "<p class=\"search-result-content\">" + highlightKeyword(content, slice) + "...</p>";
              });
              resultItem += "</div><div class='search-result-right'><img class='media-image' src='" + imgUrl + "' width='64px' height='48px'></img></div></a>";

              resultItems.push({item: resultItem, searchTextCount: searchTextCount, hitCount: hitCount, id: resultItems.length});
            }
          })
        };

        if (keywords.length === 1 && keywords[0] === "") {
          resultContent.innerHTML = '<div id="no-result"></div>'
        } else if (resultItems.length === 0) {
          resultContent.innerHTML = '<div id="no-result"></div>'
        } else {
          resultItems.sort(function (resultLeft, resultRight) {
            if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
              return resultRight.searchTextCount - resultLeft.searchTextCount;
            } else if (resultLeft.hitCount !== resultRight.hitCount) {
              return resultRight.hitCount - resultLeft.hitCount;
            } else {
              return resultRight.id - resultLeft.id;
            }
          });
          var searchResultList = '<div class=\"search-result-list\">';
          resultItems.forEach(function (result) {
            searchResultList += result.item;
          })
          searchResultList += "</div>";
          resultContent.innerHTML = searchResultList;
        }
      }
      if ('auto' === 'auto') {
        input.addEventListener('input', inputEventFunction);
      } else {
        $('.search-icon').click(inputEventFunction);
        input.addEventListener('keypress', function (event) {
          if (event.keyCode === 13) {
            inputEventFunction();
          }
        });
      }
      // remove loading animation
      $('body').css('overflow', '');
      proceedsearch();
    }
    // handle and trigger popup window;
    $('.popup-trigger').click(function (e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc('local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });
    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function (e) {
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 && $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });

    document.addEventListener('mouseup', (e) => {
      var _con = document.querySelector(".local-search-content");
      if (_con) {
        if (!_con.contains(e.target)) {
          onPopupClose();
        }
      }
    });
  </script>


		
	<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
        tex2jax: {
            inlineMath: [ ["$","$"], ["\\(","\\)"] ],
            skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code'],
            processEscapes: true
        }
    });
    MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax();
        for (var i = 0; i < all.length; ++i)
            all[i].SourceElement().parentNode.className += ' has-jax';
    });
</script>
<script src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
</body>
</html>
